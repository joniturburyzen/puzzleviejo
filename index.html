<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>El Ciclo del Aprendiz</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: #0a0a0a;
      color: #f8f9fa;
      height: 100vh;
      overflow: hidden;
      touch-action: manipulation;
      position: relative;
    }
    #progress-bar {
      position: fixed;
      top: 0;
      left: 0;
      height: 6px;
      background: rgba(255, 215, 0, 0.2);
      z-index: 1000;
      transition: width 0.8s ease;
    }
    #journey-path {
      position: fixed;
      top: 6px;
      left: 0;
      width: 100%;
      display: flex;
      justify-content: space-between;
      padding: 0 5%;
      z-index: 1001;
      font-size: 14px;
      opacity: 0.7;
    }
    .path-icon { transition: all 0.5s ease; }
    .path-icon.active { 
      opacity: 1; 
      text-shadow: 0 0 10px #ffd700;
      transform: scale(1.3);
    }
    #game-container {
      position: relative;
      width: 100%;
      height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 20px 10px 100px; /* Space for character at bottom */
      text-align: center;
      transition: background 1.2s cubic-bezier(0.4, 0, 0.2, 1);
      overflow-y: auto;
    }
    .room-1 { background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); }
    .room-2 { background: linear-gradient(135deg, #2c3e50 0%, #4a6491 100%); }
    .room-3 { background: linear-gradient(135deg, #1a2a6c 0%, #2c3e50 100%); }
    .room-4 { background: linear-gradient(135deg, #2c3e50 0%, #8e44ad 100%); }
    .room-5 { background: linear-gradient(135deg, #8e44ad 0%, #3498db 100%); }
    .room-6 { background: linear-gradient(135deg, #3498db 0%, #16a085 100%); }
    .room-7 { background: linear-gradient(135deg, #16a085 0%, #2c3e50 100%); }
    .room-8 { background: linear-gradient(135deg, #2c3e50 0%, #1a1a2e 100%); }
    .room-final { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); }

    /* CHARACTER SYSTEM - PHYSICAL PROGRESSION */
    #character-container {
      position: fixed;
      bottom: 30px;
      left: 10%; /* Updates per room */
      z-index: 2000;
      display: flex;
      flex-direction: column;
      align-items: center;
      transition: left 1.5s cubic-bezier(0.4, 0, 0.2, 1), transform 1.5s ease;
      pointer-events: none;
    }
    #character {
      font-size: 48px;
      transition: all 1.2s cubic-bezier(0.4, 0, 0.2, 1);
      text-shadow: 0 0 15px rgba(255, 215, 0, 0.8);
      position: relative;
    }
    #character-label {
      margin-top: 8px;
      font-size: 14px;
      color: rgba(255, 215, 0, 0.9);
      opacity: 0.8;
      font-weight: bold;
      white-space: nowrap;
    }
    /* Stage-specific transformations */
    .stage-1 { transform: scale(0.85); } /* Ni√±o peque√±o */
    .stage-2 { transform: scale(0.95); } /* Ni√±o */
    .stage-3 { transform: scale(1); }    /* Pre-adol */
    .stage-4 { transform: scale(1.05); } /* Adolescente */
    .stage-5 { transform: scale(1.1); }  /* Joven */
    .stage-6 { transform: scale(1.15); } /* Adulto joven */
    .stage-7 { 
      transform: scale(1.1) rotate(-2deg); 
      filter: grayscale(0.2);
    } /* Adulto */
    .stage-8 { 
      transform: scale(1) rotate(-4deg); 
      filter: grayscale(0.4);
      opacity: 0.95;
    } /* Anciano */
    .stage-9 { 
      transform: scale(0.85); 
      text-shadow: 0 0 25px rgba(255, 215, 0, 1);
      animation: pulse-gold 2s infinite;
    } /* Ni√±o renacido */
    
    /* Bast√≥n para etapas avanzadas (CSS puro) */
    #character::after {
      content: "";
      position: absolute;
      bottom: -25px;
      left: 15px;
      width: 8px;
      height: 35px;
      background: linear-gradient(to bottom, #8B4513 70%, #5D4037 100%);
      border-radius: 2px;
      transform: rotate(15deg);
      opacity: 0;
      transition: opacity 0.5s ease;
    }
    .stage-7::after, .stage-8::after { opacity: 1; }
    
    /* Canas para anciano */
    .stage-8 { 
      position: relative;
    }
    .stage-8::before {
      content: "";
      position: absolute;
      top: -15px;
      left: -5px;
      width: 60px;
      height: 20px;
      background: 
        radial-gradient(circle at 10px 10px, #e0e0e0 2px, transparent 3px),
        radial-gradient(circle at 25px 5px, #e0e0e0 2px, transparent 3px),
        radial-gradient(circle at 40px 12px, #e0e0e0 2px, transparent 3px);
      opacity: 0.85;
    }
    
    @keyframes pulse-gold {
      0%, 100% { text-shadow: 0 0 15px rgba(255, 215, 0, 0.8); }
      50% { text-shadow: 0 0 30px rgba(255, 215, 0, 1.2); }
    }
    @keyframes walk {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-5px); }
    }
    .walking { animation: walk 0.6s infinite; }

    #narrative {
      background: rgba(0, 0, 0, 0.75);
      border-radius: 18px;
      padding: 28px;
      margin: 25px 0;
      max-width: 92%;
      font-size: 19px;
      line-height: 1.65;
      box-shadow: 0 12px 35px rgba(0, 0, 0, 0.6);
      border: 2px solid rgba(255, 215, 0, 0.25);
      z-index: 10;
      position: relative;
    }
    #narrative h2 {
      color: #ffd700;
      margin-bottom: 18px;
      font-size: 26px;
      letter-spacing: -0.5px;
    }
    #narrative p {
      margin: 12px 0;
      color: #f0f2f5;
      font-weight: 300;
    }
    #puzzle-container {
      background: rgba(25, 25, 35, 0.92);
      border-radius: 22px;
      padding: 32px 25px;
      width: 94%;
      max-width: 520px;
      box-shadow: 0 18px 45px rgba(0, 0, 0, 0.75);
      border: 3px solid rgba(255, 215, 0, 0.35);
      z-index: 10;
      position: relative;
    }
    .puzzle-title {
      color: #ffd700;
      font-size: 23px;
      margin-bottom: 22px;
      font-weight: bold;
      letter-spacing: -0.5px;
    }
    input[type="text"], textarea {
      width: 100%;
      padding: 16px;
      margin: 16px 0;
      border: 2px solid #5a5a72;
      border-radius: 12px;
      background: rgba(35, 35, 50, 0.85);
      color: #e6e7eb;
      font-size: 19px;
      text-align: center;
      transition: border-color 0.3s;
    }
    input[type="text"]:focus, textarea:focus {
      outline: none;
      border-color: #ffd700;
      box-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
    }
    input[type="text"]::placeholder, textarea::placeholder {
      color: rgba(200, 200, 220, 0.6);
      font-style: italic;
    }
    button {
      background: linear-gradient(135deg, #ffd700 0%, #ffaa00 100%);
      color: #1a1a2e;
      border: none;
      padding: 16px 45px;
      margin: 12px 5px;
      border-radius: 55px;
      font-size: 19px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.25s ease;
      box-shadow: 0 6px 18px rgba(255, 170, 0, 0.4);
      position: relative;
      overflow: hidden;
      z-index: 5;
    }
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 22px rgba(255, 170, 0, 0.55);
    }
    button:active {
      transform: translateY(1px);
      box-shadow: 0 4px 12px rgba(255, 170, 0, 0.4);
    }
    button.secondary {
      background: rgba(255, 255, 255, 0.15);
      color: #ffd700;
      border: 2px solid #ffd700;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }
    button.secondary:hover {
      background: rgba(255, 215, 0, 0.25);
      transform: translateY(-1px);
    }
    .hint {
      display: none; /* OCULTO COMPLETAMENTE - CONFIRMADO */
    }
    .success {
      color: #00e676;
      font-weight: bold;
      margin: 18px 0;
      font-size: 21px;
      animation: fadeIn 0.4s;
    }
    .error {
      color: #ff5252;
      font-weight: bold;
      margin: 18px 0;
      font-size: 19px;
      animation: shake 0.4s;
    }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-6px); }
      75% { transform: translateX(6px); }
    }
    
    /* ROOM 3: ORIENTATION DOOR */
    #orientation-door {
      font-size: 85px;
      margin: 25px 0;
      display: inline-block;
      transform: rotate(90deg);
      transition: transform 0.4s ease;
    }
    @media (orientation: landscape) {
      #orientation-door { transform: rotate(0deg); }
      #landscape-btn-container { display: block; }
    }
    #landscape-btn-container { 
      display: none; 
      margin-top: 20px;
    }
    
    /* ROOM 5: THREE EMOJIS */
    .breath-options {
      display: flex;
      justify-content: center;
      gap: 35px;
      margin: 25px 0;
      font-size: 42px;
      cursor: pointer;
    }
    .breath-option {
      transition: transform 0.2s ease, filter 0.2s ease;
      user-select: none;
    }
    .breath-option:hover { transform: scale(1.15); }
    .breath-option.inactive { 
      opacity: 0.7; 
      filter: grayscale(0.6);
    }
    .breath-option.inactive:hover { 
      transform: scale(1.05) rotate(2deg);
      filter: grayscale(0.3) brightness(1.1);
    }
    
    /* ROOM 7: 8 EMOJIS IN CIRCLE */
    .touch-circle-container {
      width: 280px;
      height: 280px;
      position: relative;
      margin: 30px auto;
    }
    .touch-point {
      position: absolute;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 28px;
      cursor: pointer;
      background: rgba(255, 215, 0, 0.12);
      border: 2px solid rgba(255, 215, 0, 0.4);
      transition: all 0.25s ease;
      user-select: none;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
    }
    .touch-point:hover { 
      transform: scale(1.15) translateY(-3px);
      background: rgba(255, 215, 0, 0.25);
      z-index: 10;
    }
    .touch-point.correct { 
      background: rgba(0, 230, 118, 0.35); 
      transform: scale(1.25) !important;
      box-shadow: 0 0 20px rgba(0, 230, 118, 0.7);
      z-index: 20;
    }
    .touch-point.error { 
      background: rgba(255, 82, 82, 0.3); 
      transform: scale(1.1) !important;
      box-shadow: 0 0 25px rgba(255, 82, 82, 0.8);
    }
    /* Position 8 emojis in a circle */
    .pos-1 { top: 20%; left: 50%; transform: translate(-50%, -50%); }
    .pos-2 { top: 40%; left: 75%; transform: translate(-50%, -50%); }
    .pos-3 { top: 70%; left: 75%; transform: translate(-50%, -50%); }
    .pos-4 { top: 85%; left: 50%; transform: translate(-50%, -50%); }
    .pos-5 { top: 70%; left: 25%; transform: translate(-50%, -50%); }
    .pos-6 { top: 40%; left: 25%; transform: translate(-50%, -50%); }
    .pos-7 { top: 30%; left: 60%; transform: translate(-50%, -50%); }
    .pos-8 { top: 60%; left: 40%; transform: translate(-50%, -50%); }
    
    /* ROOM 8: ECHO PUZZLE */
    #echo-hint {
      margin-top: 20px;
      font-style: italic;
      color: #ffd700;
      min-height: 24px;
      opacity: 0;
      transition: opacity 0.5s ease;
    }
    #echo-hint.show { opacity: 1; }
    
    /* FINAL SCENE */
    #final-text {
      font-size: 26px;
      line-height: 1.7;
      color: #ffd700;
      text-shadow: 0 0 25px rgba(255, 215, 0, 0.8);
      margin: 45px 0;
      padding: 35px;
      background: rgba(0, 0, 0, 0.65);
      border-radius: 24px;
      border: 3px solid #ffd700;
      max-width: 85%;
    }
    
    /* TRANSITION EFFECTS */
    .room-transition {
      opacity: 0.2;
      filter: blur(5px);
      transition: opacity 0.6s, filter 0.6s;
    }
    
    /* MOBILE OPTIMIZATION */
    @media (max-width: 480px) {
      #character { font-size: 42px; }
      #character-label { font-size: 13px; }
      #narrative { font-size: 17px; padding: 24px 20px; }
      #narrative h2 { font-size: 24px; }
      input[type="text"], textarea { padding: 14px; font-size: 17px; }
      button { padding: 14px 38px; font-size: 17px; }
      .breath-options { gap: 25px; font-size: 38px; }
      .touch-circle-container { width: 250px; height: 250px; }
      .touch-point { width: 55px; height: 55px; font-size: 26px; }
      #final-text { font-size: 23px; padding: 28px; }
    }
  </style>
</head>
<body>
  <div id="progress-bar"></div>
  <div id="journey-path">
    <span class="path-icon active">üå±</span>
    <span class="path-icon">üß©</span>
    <span class="path-icon">üö™</span>
    <span class="path-icon">‚è∞</span>
    <span class="path-icon">üí®</span>
    <span class="path-icon">üßµ</span>
    <span class="path-icon">üåë</span>
    <span class="path-icon">üö™</span>
    <span class="path-icon">‚ú®</span>
  </div>
  
  <div id="game-container" class="room-1">
    <div id="narrative">
      <h2>üå± Sala 1: El Jard√≠n de los Secretos</h2>
      <p><em>"Peque√±a semilla... los secretos no se esconden. Solo esperan a que aprendas a mirar sin ver."</em></p>
    </div>
    <div id="puzzle-container">
      <div class="puzzle-title">El Espejo Roto</div>
      <div style="color:rgba(255,255,255,0.98);background:rgba(255,255,255,0.98);padding:10px 20px;border-radius:10px;margin:25px 0;font-size:20px;letter-spacing:2px;user-select:all;-webkit-user-select:all;">LIBERTAD</div>
      <input type="text" id="puzzle-input" placeholder="..." autocomplete="off">
      <button id="submit-btn">Confirmar</button>
      <div id="feedback"></div>
    </div>
  </div>
  
  <div id="character-container">
    <div id="character" class="stage-1 walking">üë∂</div>
    <div id="character-label">Peque√±a semilla</div>
  </div>

  <script>
    // GAME STATE - CHARACTER PHYSICAL PROGRESSION IS CORE
    const gameState = {
      currentRoom: 1,
      characterStage: 1,
      characterPositions: ['10%', '18%', '26%', '34%', '42%', '50%', '58%', '66%', '10%'], // 9 stages (final rebirth returns to start)
      characterEmojis: ['üë∂', 'üë¶', 'üßí', 'üßë', 'üë®', 'üßî', 'üë¥', 'üßì', 'üë∂'],
      characterStages: ['stage-1', 'stage-2', 'stage-3', 'stage-4', 'stage-5', 'stage-6', 'stage-7', 'stage-8', 'stage-9'],
      characterLabels: [
        'Peque√±a semilla', 
        'Brote que pregunta', 
        'Tallo que busca el sol', 
        'Rama que se dobla', 
        '√Årbol con primer fruto', 
        'Tronco con cicatrices', 
        'Ra√≠z en la oscuridad', 
        'Bosque de ciclos', 
        'Semilla que recuerda'
      ],
      roomClasses: ['room-1', 'room-2', 'room-3', 'room-4', 'room-5', 'room-6', 'room-7', 'room-8', 'room-final'],
      narratives: [
        { title: 'üå± Sala 1: El Jard√≠n de los Secretos', text: '"Peque√±a semilla... los secretos no se esconden. Solo esperan a que aprendas a mirar sin ver."' },
        { title: 'üß© Sala 2: El Pasillo de los Espejos', text: '"Brote que pregunta... ¬øqui√©n es el √∫nico lazo que el tiempo no puede romper?"' },
        { title: 'üö™ Sala 3: El Espejo Digital', text: '"Tallo que busca el sol... mi mundo est√° torcido. Endereza tu realidad para encontrar el camino."' },
        { title: '‚è∞ Sala 4: La Torre del Tiempo', text: '"Rama que se dobla al viento... el tiempo es un c√≠rculo roto. Encuentra el punto donde ayer y ma√±ana se tocan."' },
        { title: 'üí® Sala 5: El Valle del Aliento', text: '"√Årbol que sostiene su primer fruto... a veces lo que falta no es fuerza. Es aliento."' },
        { title: 'üßµ Sala 6: El Telar de los D√≠as', text: '"Tronco que carga cicatrices... si ayer fuera ma√±ana, ¬ød√≥nde quedar√≠a hoy atrapado?"' },
        { title: 'üåë Sala 7: La C√°mara del Eco', text: '"Ra√≠z que abraza la oscuridad... la luz ciega. Solo en la sombra aprendes a ver con el alma. Toca primero tu coraz√≥n, luego tu mente, y finalmente tus manos. As√≠ ver√°s lo que la luz esconde."' },
        { title: 'üö™ Sala 8: La Puerta Final', text: '"Bosque que conoce todos los ciclos... una √∫ltima pregunta resonar√° en la eternidad: Hablo sin boca, escucho sin o√≠dos, y nado en el viento. ¬øQu√© soy?"' },
        { title: '‚ú® El Regreso', text: '"Mira: vuelves a ser quien eras. Pero ahora no es inocencia ciega... es sabidur√≠a disfrazada de asombro. No envejecemos para llegar a ser viejos... envejecemos para recordar c√≥mo ser ni√±os con el alma intacta. La semilla que recuerda ser √°rbol... nunca muere. Solo espera el pr√≥ximo ciclo."' }
      ],
      puzzles: [
        { type: 'clipboard', answer: 'libertad' },
        { type: 'logic', answer: 'hijo' },
        { type: 'orientation', answer: 'landscape' },
        { type: 'logic', answer: 'ayer' },
        { type: 'breath', answer: 'blow' },
        { type: 'logic', answer: 'domingo' },
        { type: 'touch', answer: 'sequence' },
        { type: 'logic', answer: 'eco' }
      ],
      echoFailCount: 0
    };

    // DOM ELEMENTS
    const gameContainer = document.getElementById('game-container');
    const characterContainer = document.getElementById('character-container');
    const characterElement = document.getElementById('character');
    const characterLabel = document.getElementById('character-label');
    const narrativeElement = document.getElementById('narrative');
    const puzzleContainer = document.getElementById('puzzle-container');
    const progressBar = document.getElementById('progress-bar');
    const pathIcons = document.querySelectorAll('.path-icon');
    const feedbackElement = document.getElementById('feedback');

    // UPDATE PROGRESS BAR AND PATH
    function updateProgress() {
      progressBar.style.width = `${(gameState.currentRoom - 1) / 8 * 100}%`;
      pathIcons.forEach((icon, i) => {
        icon.classList.toggle('active', i === gameState.currentRoom - 1);
      });
    }

    // CHARACTER TRANSITION BETWEEN ROOMS
    function advanceCharacter() {
      // Remove walking animation during transition
      characterElement.classList.remove('walking');
      
      // Animate character to next position
      characterContainer.style.left = gameState.characterPositions[gameState.characterStage - 1];
      
      // Update appearance after movement
      setTimeout(() => {
        characterElement.textContent = gameState.characterEmojis[gameState.characterStage - 1];
        characterElement.className = gameState.characterStages[gameState.characterStage - 1];
        characterLabel.textContent = gameState.characterLabels[gameState.characterStage - 1];
        
        // Restore walking animation
        setTimeout(() => {
          characterElement.classList.add('walking');
        }, 300);
      }, 800);
    }

    // ROOM TRANSITION WITH CHARACTER MOVEMENT
    function advanceRoom() {
      // Start room transition effect
      gameContainer.classList.add('room-transition');
      
      // Advance game state
      gameState.currentRoom++;
      gameState.characterStage++;
      
      // Update progress UI
      updateProgress();
      
      // Move character physically to next position
      advanceCharacter();
      
      // After transition, update room content
      setTimeout(() => {
        // Update room background
        gameContainer.className = gameState.roomClasses[gameState.currentRoom - 1];
        
        // Update narrative
        narrativeElement.innerHTML = `
          <h2>${gameState.narratives[gameState.currentRoom - 1].title}</h2>
          <p><em>${gameState.narratives[gameState.currentRoom - 1].text}</em></p>
        `;
        
        // Setup new puzzle
        setupPuzzle();
        
        // Remove transition effect
        gameContainer.classList.remove('room-transition');
      }, 900);
    }

    // FINAL TRANSFORMATION SCENE
    function showFinalScene() {
      gameState.currentRoom = 9;
      updateProgress();
      
      // Update room background
      gameContainer.className = gameState.roomClasses[8];
      
      // Update narrative
      narrativeElement.innerHTML = `
        <h2>${gameState.narratives[8].title}</h2>
        <p><em>${gameState.narratives[8].text}</em></p>
      `;
      
      // Hide puzzle container temporarily
      puzzleContainer.style.opacity = '0';
      
      // Start transformation sequence
      setTimeout(() => {
        // Elder appearance
        characterElement.textContent = 'üßì';
        characterElement.className = 'stage-8';
        characterLabel.textContent = 'Bosque de ciclos';
        
        // Begin transformation
        characterElement.style.opacity = '0.6';
        characterElement.style.transform = 'scale(1.4) rotate(-5deg)';
        
        setTimeout(() => {
          // Magical transition
          characterElement.textContent = '‚ú®';
          characterElement.style.fontSize = '70px';
          characterElement.style.textShadow = '0 0 30px rgba(255, 215, 0, 1.2)';
          
          setTimeout(() => {
            // Rebirth as child
            characterElement.textContent = 'üë∂';
            characterElement.className = 'stage-9';
            characterLabel.textContent = 'Semilla que recuerda';
            characterElement.style.cssText = '';
            
            // Show final message
            puzzleContainer.innerHTML = `
              <div id="final-text">
                <p><strong>"No envejecemos para llegar a ser viejos...</strong><br>
                <strong>envejecemos para recordar c√≥mo ser ni√±os</strong><br>
                <strong>con el alma intacta."</strong></p>
                <p style="margin-top:35px;font-size:20px;">----------</p>
                <p style="margin-top:25px;color:#00e676;">Gracias por recordar. üå±</p>
              </div>
              <button id="restart-btn" style="margin-top:35px;background:linear-gradient(135deg,#00e676 0%,#00c853 100%);">‚Ü∫ Comenzar de nuevo</button>
            `;
            puzzleContainer.style.opacity = '1';
            
            // Restart button
            document.getElementById('restart-btn').addEventListener('click', () => {
              location.reload();
            });
          }, 1500);
        }, 1200);
      }, 600);
    }

    // SETUP PUZZLES PER ROOM
    function setupPuzzle() {
      let puzzleHTML = '';
      const puzzle = gameState.puzzles[gameState.currentRoom - 1];
      
      switch(gameState.currentRoom) {
        case 1: // Clipboard
          puzzleHTML = `
            <div class="puzzle-title">El Espejo Roto</div>
            <div style="color:rgba(255,255,255,0.98);background:rgba(255,255,255,0.98);padding:10px 20px;border-radius:10px;margin:25px 0;font-size:20px;letter-spacing:2px;user-select:all;-webkit-user-select:all;">LIBERTAD</div>
            <input type="text" id="puzzle-input" placeholder="..." autocomplete="off">
            <button id="submit-btn">Confirmar</button>
            <div id="feedback"></div>
          `;
          break;
          
        case 2: // Portrait
          puzzleHTML = `
            <div class="puzzle-title">El Retrato Familiar</div>
            <p style="margin:15px 0;font-size:19px;line-height:1.6">"Hermanos y hermanas no tengo. Pero el padre de este hombre es hijo √∫nico de mi padre. ¬øQui√©n es el hombre del retrato?"</p>
            <input type="text" id="puzzle-input" placeholder="..." autocomplete="off">
            <button id="submit-btn">Responder</button>
            <div id="feedback"></div>
          `;
          break;
          
        case 3: // Orientation (NO INSTRUCTIONS)
          puzzleHTML = `
            <div class="puzzle-title">La Puerta Torcida</div>
            <div id="orientation-door">üö™</div>
            <div id="landscape-btn-container">
              <button id="landscape-btn">‚Üí</button>
            </div>
            <div id="feedback"></div>
          `;
          break;
          
        case 4: // Day Special
          puzzleHTML = `
            <div class="puzzle-title">El C√≠rculo del Tiempo</div>
            <p style="margin:15px 0;font-size:19px;line-height:1.6">"¬øQu√© d√≠a viene inmediatamente despu√©s del d√≠a que est√° antes de ayer?"</p>
            <input type="text" id="puzzle-input" placeholder="..." autocomplete="off">
            <button id="submit-btn">Responder</button>
            <div id="feedback"></div>
          `;
          break;
          
        case 5: // Breath (THREE EMOJIS - NO BARS)
          puzzleHTML = `
            <div class="puzzle-title">El Valle Dormido</div>
            <p style="margin:15px 0 25px;font-size:19px;line-height:1.6">El viento ha cesado. Solo tu aliento puede despertarlo.</p>
            <div class="breath-options">
              <div class="breath-option" id="wind">üå¨Ô∏è</div>
              <div class="breath-option inactive" id="fire">üî•</div>
              <div class="breath-option inactive" id="water">üíß</div>
            </div>
            <div id="feedback"></div>
          `;
          break;
          
        case 6: // Time Thread
          puzzleHTML = `
            <div class="puzzle-title">El Telar Roto</div>
            <p style="margin:15px 0;font-size:19px;line-height:1.6">"Si ayer fuera ma√±ana, hoy ser√≠a viernes. ¬øQu√© d√≠a es hoy realmente?"</p>
            <input type="text" id="puzzle-input" placeholder="..." autocomplete="off">
            <button id="submit-btn">Responder</button>
            <div id="feedback"></div>
          `;
          break;
          
        case 7: // Touch Sequence (8 EMOJIS IN CIRCLE)
          puzzleHTML = `
            <div class="puzzle-title">La Sombra Interior</div>
            <p style="margin:15px 0 20px;font-size:19px;line-height:1.6">Toca en el orden correcto.</p>
            <div class="touch-circle-container">
              <div class="touch-point pos-1" data-id="heart">‚ù§Ô∏è</div>
              <div class="touch-point pos-2" data-id="broken">üíî</div>
              <div class="touch-point pos-3" data-id="brain">üß†</div>
              <div class="touch-point pos-4" data-id="mind">üí≠</div>
              <div class="touch-point pos-5" data-id="hand">‚úã</div>
              <div class="touch-point pos-6" data-id="palms">üëê</div>
              <div class="touch-point pos-7" data-id="eye">üëÅÔ∏è</div>
              <div class="touch-point pos-8" data-id="moon">üåô</div>
            </div>
            <div id="feedback"></div>
          `;
          break;
          
        case 8: // Echo Puzzle (EXPLICIT ANSWER)
          puzzleHTML = `
            <div class="puzzle-title">El Eco Final</div>
            <p style="margin:15px 0;font-size:19px;line-height:1.6">"Hablo sin boca, escucho sin o√≠dos, y nado en el viento. ¬øQu√© soy?"</p>
            <input type="text" id="puzzle-input" placeholder="..." autocomplete="off">
            <button id="submit-btn">Responder</button>
            <div id="echo-hint">...</div>
            <div id="feedback"></div>
          `;
          break;
      }
      
      puzzleContainer.innerHTML = puzzleHTML;
      setupPuzzleListeners();
    }

    // SETUP PUZZLE INTERACTIONS
    function setupPuzzleListeners() {
      const puzzle = gameState.puzzles[gameState.currentRoom - 1];
      
      // Room 3: Orientation button
      if (gameState.currentRoom === 3) {
        const btn = document.getElementById('landscape-btn');
        if (btn) {
          btn.addEventListener('click', () => {
            if (window.matchMedia('(orientation: landscape)').matches) {
              feedbackElement.innerHTML = '<div class="success">‚ú® El mundo se endereza...</div>';
              setTimeout(() => advanceRoom(), 1000);
            } else {
              feedbackElement.innerHTML = '<div class="error">‚ùå La puerta sigue torcida...</div>';
              if (navigator.vibrate) navigator.vibrate(100);
            }
          });
        }
        return;
      }
      
      // Room 5: Breath emojis
      if (gameState.currentRoom === 5) {
        document.getElementById('wind').addEventListener('click', startBreathDetection);
        document.getElementById('fire').addEventListener('click', wrongBreathOption);
        document.getElementById('water').addEventListener('click', wrongBreathOption);
        return;
      }
      
      // Room 7: Touch sequence
      if (gameState.currentRoom === 7) {
        setupTouchSequence();
        return;
      }
      
      // Room 8: Echo puzzle with hint after failures
      if (gameState.currentRoom === 8) {
        document.getElementById('submit-btn').addEventListener('click', () => {
          const input = document.getElementById('puzzle-input').value.trim().toLowerCase();
          const cleanInput = input.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
          
          if (cleanInput.includes('eco') || cleanInput.includes('echo')) {
            feedbackElement.innerHTML = '<div class="success">‚ú® El eco responde... y el camino se abre.</div>';
            setTimeout(() => showFinalScene(), 1200);
          } else {
            gameState.echoFailCount++;
            feedbackElement.innerHTML = '<div class="error">‚ùå El silencio persiste...</div>';
            if (navigator.vibrate) navigator.vibrate(80);
            
            // Show hint after 2 failures
            if (gameState.echoFailCount >= 2) {
              document.getElementById('echo-hint').textContent = '"Busca lo que repite tus palabras sin entenderlas..."';
              document.getElementById('echo-hint').classList.add('show');
            }
          }
        });
        return;
      }
      
      // Default: Text input puzzles (Rooms 1,2,4,6)
      document.getElementById('submit-btn')?.addEventListener('click', () => {
        const input = document.getElementById('puzzle-input').value.trim().toLowerCase();
        const cleanInput = input.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        let correct = false;
        
        switch(gameState.currentRoom) {
          case 1: correct = cleanInput === 'libertad'; break;
          case 2: correct = ['hijo', 'mihijo', 'elhijo'].includes(cleanInput.replace(/\s/g, '')); break;
          case 4: correct = cleanInput === 'ayer'; break;
          case 6: correct = ['domingo', 'dom'].includes(cleanInput); break;
        }
        
        if (correct) {
          const messages = [
            '‚ú® El espejo se ilumina...',
            '‚ú® El lazo eres t√∫ mismo...',
            '‚ú® Siempre fue hoy...',
            '‚ú® Atrapado en el presente...'
          ];
          feedbackElement.innerHTML = `<div class="success">${messages[gameState.currentRoom-1]}</div>`;
          setTimeout(() => advanceRoom(), 1000);
        } else {
          feedbackElement.innerHTML = '<div class="error">‚ùå ¬øEs eso lo que realmente ves?</div>';
          if (navigator.vibrate) navigator.vibrate(70);
        }
      });
    }

    // ROOM 5: BREATH DETECTION (NO VISUALIZER)
    function startBreathDetection() {
      feedbackElement.innerHTML = '<div style="color:#ffd700;margin:15px 0">üå¨Ô∏è Escuchando...</div>';
      
      // Haptic feedback on activation
      if (navigator.vibrate) navigator.vibrate(50);
      
      // Request mic permission
      navigator.mediaDevices.getUserMedia({ audio: true })
        .then(stream => {
          const audioContext = new (window.AudioContext || window.webkitAudioContext)();
          const analyser = audioContext.createAnalyser();
          const source = audioContext.createMediaStreamSource(stream);
          source.connect(analyser);
          
          analyser.fftSize = 256;
          const bufferLength = analyser.frequencyBinCount;
          const dataArray = new Uint8Array(bufferLength);
          
          let blowDetected = false;
          let timeout = setTimeout(() => {
            if (!blowDetected) {
              feedbackElement.innerHTML = '<div class="error">‚ùå El valle permanece en silencio...</div>';
              if (navigator.vibrate) navigator.vibrate(100);
              stream.getTracks().forEach(track => track.stop());
            }
          }, 5000); // 5 second timeout
          
          function checkVolume() {
            if (blowDetected) return;
            
            analyser.getByteFrequencyData(dataArray);
            let sum = 0;
            for (let i = 0; i < bufferLength; i++) sum += dataArray[i];
            const average = sum / bufferLength;
            
            // THRESHOLD 50 - SUAVE SUSPIRO
            if (average > 50) {
              blowDetected = true;
              clearTimeout(timeout);
              stream.getTracks().forEach(track => track.stop());
              
              feedbackElement.innerHTML = '<div class="success">‚ú® El valle cobra vida...</div>';
              setTimeout(() => advanceRoom(), 1000);
            } else {
              requestAnimationFrame(checkVolume);
            }
          }
          
          checkVolume();
        })
        .catch(err => {
          console.error("Mic error:", err);
          feedbackElement.innerHTML = '<div class="error">‚ùå Permiso de micr√≥fono necesario</div>';
          if (navigator.vibrate) navigator.vibrate(150);
        });
    }
    
    function wrongBreathOption() {
      // Subtle shake effect on character
      characterElement.style.animation = 'shake 0.3s';
      setTimeout(() => {
        characterElement.style.animation = '';
      }, 300);
      
      // Haptic feedback
      if (navigator.vibrate) navigator.vibrate(60);
    }

    // ROOM 7: TOUCH SEQUENCE (8 EMOJIS)
    function setupTouchSequence() {
      const sequence = ['heart', 'mind', 'hand']; // ‚ù§Ô∏è üí≠ ‚úã
      let currentStep = 0;
      const points = document.querySelectorAll('.touch-point');
      
      points.forEach(point => {
        point.addEventListener('click', () => {
          const id = point.dataset.id;
          
          if (id === sequence[currentStep]) {
            // Correct touch
            point.classList.add('correct');
            currentStep++;
            
            if (currentStep === sequence.length) {
              feedbackElement.innerHTML = '<div class="success">‚ú® La oscuridad se disipa...</div>';
              setTimeout(() => advanceRoom(), 1000);
            }
          } else {
            // Wrong touch - reset sequence
            points.forEach(p => {
              p.classList.remove('correct');
              p.classList.add('error');
            });
            
            setTimeout(() => {
              points.forEach(p => p.classList.remove('error'));
            }, 300);
            
            currentStep = 0;
            feedbackElement.innerHTML = '<div class="error">‚ùå El orden es esencial...</div>';
            if (navigator.vibrate) navigator.vibrate(100);
          }
        });
      });
    }

    // INITIALIZE GAME
    updateProgress();
    setupPuzzleListeners();
    
    // Character starts walking animation
    setTimeout(() => {
      characterElement.classList.add('walking');
    }, 500);
    
    console.log("üå± El Ciclo del Aprendiz - Versi√≥n final con progresi√≥n f√≠sica del personaje");
  </script>
</body>
</html>
